<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ã‚¤ãƒ•ãƒ­ã‚°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰App</title>
    <style>
        /* ã‚¹ãƒãƒ›å‘ã‘ã®ã‹ã‚“ãŸã‚“ãªãƒ‡ã‚¶ã‚¤ãƒ³ */
        body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; text-align: center; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; }
        
        /* ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .btn {
            display: block; width: 100%; padding: 15px; margin: 10px 0;
            border: none; border-radius: 5px; font-size: 16px; cursor: pointer;
        }
        .btn-select { background-color: #007bff; color: white; }
        .btn-upload { background-color: #28a745; color: white; }
        .btn:disabled { background-color: #ccc; }
        
        /* éš ã—è¦ç´  */
        #fileInput { display: none; }
        #status { margin-top: 15px; font-weight: bold; color: #555; }
        #preview { max-width: 100%; margin-top: 10px; display: none; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="global-header"></div>
    <script src="header.js"></script>
    <div class="card">
    <h2>ãƒ©ã‚¤ãƒ•ãƒ­ã‚°è¨˜éŒ²ã‚¢ãƒ—ãƒª</h2>
    
    <button onclick="document.getElementById('fileInput').click()" class="btn btn-select">
        ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹• / å‹•ç”»é¸æŠ
    </button>
    
    <input type="file" id="fileInput" accept="video/*,image/*" capture="environment">

    <video id="preview" controls></video>
    <p id="fileInfo">ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœªé¸æŠã§ã™</p>

    <button id="uploadBtn" class="btn btn-upload" onclick="startUpload()" disabled>
        ğŸš€ ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦é€ä¿¡
    </button>

    <p id="status"></p>
</div>

<script>
    // ã€é‡è¦ã€‘ã“ã“ã«ä½œæˆã—ãŸAPI Gatewayã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    // æœ«å°¾ã® /get-upload-url ãªã©ã¯å‰Šé™¤ã—ã€ãƒ‰ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†ã ã‘ã«ã—ã¦ãã ã•ã„
    const API_BASE_URL = "REPLACE_ME_API_URL";

    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusText = document.getElementById('status');
    const preview = document.getElementById('preview');
    let selectedFile = null;

    // 1. ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸæ™‚ã®å‡¦ç†
    fileInput.addEventListener('change', (event) => {
        if (event.target.files.length > 0) {
            selectedFile = event.target.files[0];
            document.getElementById('fileInfo').innerText = `é¸æŠä¸­: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            preview.style.display = 'block';
            preview.src = URL.createObjectURL(selectedFile);
            
            uploadBtn.disabled = false; // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            statusText.innerText = "é€ä¿¡æº–å‚™OK";
        }
    });

    // 2. é€ä¿¡ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼‰
    async function startUpload() {
        uploadBtn.disabled = true;
        statusText.innerText = "ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...";

        // ä½ç½®æƒ…å ±ã®å–å¾—
        if (!navigator.geolocation) {
            alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
            return;
        }

        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            statusText.innerText = `ğŸ“ å–å¾—å®Œäº†: ${lat.toFixed(4)}, ${lon.toFixed(4)}\nğŸ”„ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...`;
            
            try {
                // A. ç½²åä»˜ãURLã‚’Lambdaã‹ã‚‰ã‚‚ã‚‰ã†
                const urlRes = await fetch(`${API_BASE_URL}/get-upload-url`);
                if (!urlRes.ok) throw new Error("URLç™ºè¡Œã‚¨ãƒ©ãƒ¼");
                const urlData = await urlRes.json();
                
                const uploadUrl = urlData.uploadUrl;
                const savedFileName = urlData.fileName;

                // B. S3ã¸ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (PUT)
                statusText.innerText = "ğŸ“¤ å‹•ç”»ã‚’S3ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...";
                
                const uploadRes = await fetch(uploadUrl, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "video/mp4" // Lambdaã®è¨­å®šã¨åˆã‚ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                    },
                    body: selectedFile
                });

                if (!uploadRes.ok) throw new Error("S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼");

                // C. å®Œäº†é€šçŸ¥ã¨ãƒ‡ãƒ¼ã‚¿ã‚’DynamoDBã¸ (POST)
                statusText.innerText = "ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...";
                
                const saveRes = await fetch(`${API_BASE_URL}/save-data`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        userId: "guest-user", // ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ãŒãªã„ã®ã§ä»®ã®ID
                        lat: lat,
                        lon: lon,
                        fileName: savedFileName,
                        bucketName: "your-bucket-name" // â€»æœ¬æ¥ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ç®¡ç†ã™ã¹ãã§ã™ãŒç°¡æ˜“å®Ÿè£…ã®ãŸã‚
                    })
                });

                if (!saveRes.ok) throw new Error("ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼");

                statusText.innerText = "âœ… ã™ã¹ã¦å®Œäº†ã—ã¾ã—ãŸï¼";
                alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼");

            } catch (error) {
                console.error(error);
                statusText.innerText = "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message;
                uploadBtn.disabled = false;
            }

        }, (error) => {
            statusText.innerText = "âŒ ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
            console.error(error);
            uploadBtn.disabled = false;
        });
    }
</script>

</body>
</html>